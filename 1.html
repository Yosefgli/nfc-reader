<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×–×™×”×•×™</title>
    <style>
        body { text-align: center; font-family: Arial, sans-serif; direction: rtl; }
        video { width: 50%; border: 2px solid black; }
        #successModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 2px solid green; }
    </style>
</head>
<body>
    <h2>××¢×¨×›×ª ×–×™×”×•×™</h2>
    <video id="camera" autoplay></video>
    <div id="successModal">
        <h3>×–×™×”×•×™ ×”×¦×œ×™×—!</h3>
        <p id="userName"></p>
    </div>
    
    <script>
        const nfcData = {
    "2e:f0:cf:d4": "×™×•×¡×™ ×›×”×Ÿ",
    "be:87:cd:d4": "×“× ×” ×œ×•×™",
    "0455667788": "××‘×™ ×™×©×¨××œ×™"
};

const webhookUrl = "https://hook.us1.make.com/y5bn1g4msd14fa0fxcvfmjpzo87kbxke";

async function startCamera() {
    const video = document.createElement("video");
    video.style.width = "100vw";
    video.style.height = "100vh";
    document.body.appendChild(video);
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.play();
    } catch (err) {
        console.error("Error accessing camera:", err);
    }
}

async function captureImage(video) {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    return canvas.toDataURL("image/png");
}

document.addEventListener("DOMContentLoaded", async () => {
    await startCamera();
    if ("NDEFReader" in window) {
        try {
            const nfcReader = new NDEFReader();
            await nfcReader.scan();

            nfcReader.onreading = async (event) => {
                event.preventDefault();
                let scannedUID = event.serialNumber.trim();
                
                if (nfcData[scannedUID]) {
                    alert(`×–×•×”×” ×›×¨×˜×™×¡: ${nfcData[scannedUID]}`);
                    
                    const video = document.querySelector("video");
                    const imageData = await captureImage(video);
                    
                    sendWebhook(scannedUID, nfcData[scannedUID], imageData);
                } else {
                    alert("×›×¨×˜×™×¡ ×œ× ××–×•×”×”");
                }
            };
        } catch (error) {
            console.error("âŒ ×©×’×™××”:", error.message);
        }
    } else {
        alert("âš ï¸ ×”××›×©×™×¨ ×œ× ×ª×•××š ×‘×–×™×”×•×™ NFC");
    }
});

function sendWebhook(serialNumber, name, image) {
    fetch(webhookUrl, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ serialNumber, name, image })
    })
    .then(response => response.json())
    .then(data => console.log("ğŸš€ ×•×•×‘×”×•×§ × ×©×œ×— ×‘×”×¦×œ×—×”:", data))
    .catch(error => console.error("âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×•×‘×”×•×§:", error));
}

    </script>
</body>
</html>
